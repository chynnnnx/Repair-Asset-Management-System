@inherits LayoutComponentBase
@inject LogoutManager LogoutManager
@inject AuthenticationStateProvider AuthStateProvider

@if (isLoading)
{
    <Loader Visible="true" />
}
else
{
<AuthorizeView>
    <Authorized>

        <MudThemeProvider />
        <MudPopoverProvider />
        <MudDialogProvider />
        <MudSnackbarProvider />

        <MudLayout>
            <MudAppBar Elevation="2" Style="background-color:#00415a; color: #F0F0F0;">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />

                <MudIcon Icon="@Icons.Material.Filled.Build" Style="margin-right: 8px;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; margin-right: 16px;">RAMS</MudText>

                <MudSpacer />

                <AuthorizeView>
                    <Authorized Context="auth">
                        <MudText Typo="Typo.body2" Style="margin-right: 16px;">
                            Welcome back, @auth.User.FindFirst(ClaimTypes.Name)?.Value
                        </MudText>
                    </Authorized>
                  
                </AuthorizeView>

                <AuthorizeView>
                    <Authorized Context="auth">
                        @{
                            var email = auth.User.FindFirst("Email")?.Value
                            ?? auth.User.FindFirst(ClaimTypes.Email)?.Value
                            ?? "User";
                            var initials = email[0].ToString().ToUpper();
                        }
                        <MudMenu AnchorOrigin="Origin.BottomCenter"
                                 TransformOrigin="Origin.TopCenter"
                                 OffsetY="true">
                            <ActivatorContent>
                                <MudAvatar Color="@GetUserColor(email)">@initials</MudAvatar>
                            </ActivatorContent>
                            <ChildContent>
                                <MudMenuItem>Profile</MudMenuItem>
                                <MudMenuItem>Settings</MudMenuItem>
                                <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </Authorized>
                </AuthorizeView>
            </MudAppBar>

            <MudDrawer @bind-Open="_drawerOpen"
                       ClipMode="DrawerClipMode.Always"
                       Elevation="2"
                       Style="background-color: #F4F4F4;">
                <div style="padding: 16px; background-color: #00415a; color: white; text-align: center;">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                        Repair & Asset Management System
                    </MudText>
                    <MudText Typo="Typo.caption" Style="opacity: 0.8;">
                        RAMS
                    </MudText>
                </div>

                <NavMenu />
            </MudDrawer>

            <MudMainContent>
                <div style="overflow-y: auto; max-height: 100vh;">
                    @Body
                    
                </div>
            </MudMainContent>

        </MudLayout>

    </Authorized>

    <NotAuthorized>
        <MudText Typo="Typo.h5" Style="margin: 32px; color: red;">
            YOU ARE NOT AUTHORIZED
        </MudText>
    </NotAuthorized>
</AuthorizeView>
}

@code {
    bool _drawerOpen = true;
    bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isLoading = false;
    }
    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    private async Task Logout()
    {
        isLoading = true;
        StateHasChanged();

        await LogoutManager.ManageLogoutAsync();

        isLoading = false;
        StateHasChanged();
    }
    private Color GetUserColor(string userId)
    {
        var colors = new[] { Color.Info, Color.Primary, Color.Success, Color.Warning, Color.Error };
        int hash = Math.Abs(userId.GetHashCode());
        return colors[hash % colors.Length];
    }
}
